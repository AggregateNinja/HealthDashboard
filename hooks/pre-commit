#!/bin/sh
# Git pre-commit hook to require package.json version bump on ANY commit

PACKAGE_JSON="package.json"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# If no files are staged (shouldn’t happen in pre-commit), exit
if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Check if package.json is staged
if echo "$STAGED_FILES" | grep -q "^$PACKAGE_JSON$"; then
  # Compare version in HEAD vs staged using Node.js
  PREV_VERSION=$(git show HEAD:$PACKAGE_JSON 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync(0)).version")
  CURRENT_VERSION=$(git show :$PACKAGE_JSON | node -p "JSON.parse(require('fs').readFileSync(0)).version")

  if [ "$CURRENT_VERSION" = "$PREV_VERSION" ]; then
    echo "Commit blocked: package.json version ($CURRENT_VERSION) has not been updated."
    echo "Please bump the version in package.json before committing."
    exit 1
  else
    echo "package.json version updated: $PREV_VERSION → $CURRENT_VERSION"
  fi
else
  echo "Commit blocked: You changed files but did not bump the package.json version."
  echo "Please update package.json and stage it with a new version before committing."
  exit 1
fi

exit 0